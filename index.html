<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GoT Duplex: Conversational Behavior Reasoning</title>
  <meta name="description" content="Interactive GoT demo: play audio and scrub by second to see high/low-level labels, rationale text, and raw/updated weight & node graphs." />
  <meta name="keywords" content="GoT, conversational behavior, reasoning, graph of thoughts, demo" />

  <!-- Minimal deps -->
  <link href="https://fonts.googleapis.com/css?family=Google+Sans|Noto+Sans|Castoro" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css" />
  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />

  <style>
    :root{
      --sky-bg:#E9F3FF;  /* 天蓝背景 */
      --sky-line:#2F80ED;/* 天蓝竖线/主色 */
      --sky-text:#1E40AF;/* 天蓝文字 */
      --box-border:#E6E8EB;
    }
    body{font-family:"Google Sans","Noto Sans",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .navbar{box-shadow:none}
    .publication-title{letter-spacing:.2px}

    /* 让 Plyr 进度条左右贴边 */
    .plyr--audio .plyr__controls{padding-left:0!important;padding-right:0!important}

    /* Rationale 盒子 */
    .got-rbox{border:1px solid var(--box-border);border-radius:14px;padding:14px;background:#fcfcfd}
    .got-row{display:grid;grid-template-columns:120px 1fr;gap:10px;align-items:center;margin:10px 0}
    .got-key{color:#6b7280;font-weight:700;text-transform:uppercase;font-size:.8rem;letter-spacing:.04em}

    /* 小方块 chip（High/Low 用） */
    .chip{
      display:inline-block; padding:6px 10px; border-radius:10px;
      background:var(--sky-bg); color:var(--sky-text); border:1px solid #CFE2FF;
      font-weight:600; line-height:1; white-space:nowrap;
    }

    /* 文本信息框（左侧天蓝竖线） */
    .got-msg{
      background:var(--sky-bg); border-left:4px solid var(--sky-line);
      border-radius:10px; padding:10px 12px; color:var(--sky-text); margin:0;
    }

    /* 四图宫格 */
    .got-grid{display:grid;grid-template-columns:repeat(2,minmax(260px,1fr));gap:16px;margin-top:16px}
    .got-card{border:1px solid var(--box-border);border-radius:12px;padding:10px;background:#fff}
    .got-cap{margin:0 0 6px 0;font-weight:600}
    .got-img{width:100%;max-width:760px;height:auto;border-radius:8px}
    @media (max-width:720px){.got-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>

<!-- Navbar：只留 Demo -->
<nav class="navbar" role="navigation" aria-label="main navigation">
  <div class="navbar-menu">
    <div class="navbar-start" style="flex-grow:1;justify-content:center;gap:10px;">
      <a class="navbar-item" href="#got-demo">Demo</a>
    </div>
  </div>
</nav>

<!-- Hero / Title -->
<section class="hero">
  <div class="hero-body">
    <div class="container is-max-desktop">
      <div class="columns is-centered">
        <div class="column has-text-centered">
          <h1 class="title is-1 publication-title">GoT Duplex: Conversational Behavior Reasoning</h1>
          <div class="column has-text-centered">
            <a href="#got-demo" class="button is-dark is-rounded">
              <span class="icon"><i class="fas fa-magic"></i></span><span>Demo</span>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- ===== GoT per-second demo ===== -->
<section class="section" id="got-demo">
  <div class="container is-max-desktop">
    <h2 class="title is-3">Interactive GoT Viewer (1s granularity)</h2>

    <!-- 只保留音频播放器（使用其自带进度条拖动） -->
    <audio id="aud" controls playsinline>
      <source src="assets/audio/clip.mp3" type="audio/mpeg" />
      <source src="assets/audio/clip.wav" type="audio/wav" />
      Your browser does not support the audio element.
    </audio>

    <!-- Rationale：T / High / Low / Text -->
    <div class="got-rbox">
      <div class="got-row">
        <div class="got-key">T</div>
        <div><span id="tval">0</span> s</div>
      </div>
      <div class="got-row">
        <div class="got-key">High-level</div>
        <div><span id="hi" class="chip">—</span></div>
      </div>
      <div class="got-row">
        <div class="got-key">Low-level</div>
        <div><span id="lo" class="chip">—</span></div>
      </div>
      <div class="got-row">
        <div class="got-key">Text</div>
        <div><div id="rat" class="got-msg">—</div></div>
      </div>
    </div>

    <!-- 四图：Raw/Updated × Weight/Node -->
    <div class="got-grid">
      <figure class="got-card">
        <figcaption class="got-cap">Raw · Weight matrix</figcaption>
        <img id="img-raw-w" class="got-img" src="assets/alpha_raw_weight/000.png" alt="Raw weight matrix at t=0" loading="lazy" />
      </figure>
      <figure class="got-card">
        <figcaption class="got-cap">Raw · Node graph</figcaption>
        <img id="img-raw-n" class="got-img" src="assets/alpha_raw_node/000.png" alt="Raw node graph at t=0" loading="lazy" />
      </figure>
      <figure class="got-card">
        <figcaption class="got-cap">Updated · Weight matrix</figcaption>
        <img id="img-upd-w" class="got-img" src="assets/alpha_upd_weight/000.png" alt="Updated weight matrix at t=0" loading="lazy" />
      </figure>
      <figure class="got-card">
        <figcaption class="got-cap">Updated · Node graph</figcaption>
        <img id="img-upd-n" class="got-img" src="assets/alpha_upd_node/000.png" alt="Updated node graph at t=0" loading="lazy" />
      </figure>
    </div>
  </div>
</section>

<!-- Plyr JS -->
<script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
<script>
(function(){
  const $  = id => document.getElementById(id);
  const p3 = n => String(n).padStart(3,'0');

  const player = new Plyr('#aud');
  const media  = player.media; // 原生 <audio>

  const TVAL=$('tval'), HI=$('hi'), LO=$('lo'), RAT=$('rat');
  const RAW_W=$('img-raw-w'), RAW_N=$('img-raw-n'), UPD_W=$('img-upd-w'), UPD_N=$('img-upd-n');

  let R=[], Rmap=new Map();
  let jsonLast=0, audioLast=0, smax=0, lastApplied=-1;

  // 读取 rationales.json
  fetch('assets/rationales.json')
    .then(r=>r.json())
    .then(d=>{
      R = Array.isArray(d)? d : [];
      Rmap = new Map(R.map(e => [Number(e.sec), e]));
      jsonLast = R.reduce((m,e)=>Math.max(m, Number(e.sec)||0), 0);
      recomputeMax();
      applySecond(0);
    })
    .catch(()=>{ /* ignore */ });

  function recomputeMax(){
    // 音频与 JSON 都可用时，取较小者作为最大可显示秒
    audioLast = Math.max(0, Math.floor(player.duration || media.duration || 0));
    const cands = [jsonLast, audioLast].filter(x=>x>0);
    smax = cands.length ? Math.min(...cands) : (jsonLast || audioLast || 30);
  }

  function applySecond(t){
    if(t === lastApplied) return;
    lastApplied = t;
    TVAL.textContent = String(t);

    const x = Rmap.get(t) || {};
    HI.textContent  = x.hi   || '—';
    LO.textContent  = x.lo   || '—';
    RAT.textContent = x.text || '—';

    RAW_W.src = `assets/alpha_raw_weight/${p3(t)}.png`;
    RAW_N.src = `assets/alpha_raw_node/${p3(t)}.png`;
    UPD_W.src = `assets/alpha_upd_weight/${p3(t)}.png`;
    UPD_N.src = `assets/alpha_upd_node/${p3(t)}.png`;
  }

  function clampToMax(sec){
    if(sec < 0) return 0;
    if(smax > 0 && sec > smax) return smax;
    return sec;
  }

  // 播放 / 拖动进度条时同步（依赖播放器自带轨道）
  player.on('ready',         recomputeMax);
  player.on('loadedmetadata',recomputeMax);
  player.on('timeupdate', () => {
    const cur = clampToMax(Math.floor(player.currentTime || media.currentTime || 0));
    applySecond(cur);
    preloadNext(cur);
  });
  ['seeking','seeked','play','pause'].forEach(ev=>{
    media.addEventListener(ev, ()=>{
      const cur = clampToMax(Math.floor(media.currentTime || 0));
      applySecond(cur);
    });
  });

  // 预加载下一秒四张图
  function preloadNext(t){
    const n=t+1; if(smax && n>smax) return;
    [
      `assets/alpha_raw_weight/${p3(n)}.png`,
      `assets/alpha_raw_node/${p3(n)}.png`,
      `assets/alpha_upd_weight/${p3(n)}.png`,
      `assets/alpha_upd_node/${p3(n)}.png`,
    ].forEach(src => { const im=new Image(); im.loading='eager'; im.src=src; });
  }

  // 首次渲染
  applySecond(0);
})();
</script>

</body>
</html>
